// ConsoleApplication3.cpp : Defines the entry point for the console application.
//

#include "stdafx.h"
#include <Windows.h>
#include <Wininet.h>

int _tmain(int argc, _TCHAR* argv[])
{
	TCHAR urlStr[] = L"http://www.baidu.com/";
	byte  buffer[1024];
	DWORD dwReadSize;
	DWORD dwWriteSize;

	memset(&buffer, NULL, sizeof(buffer) / sizeof(byte));
	HINTERNET hInternet = InternetOpen(NULL, INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, NULL);
	if (NULL != hInternet)
	{
		HINTERNET hOpenURL = InternetOpenUrl(hInternet,
			urlStr,
			NULL,
			NULL,
			INTERNET_FLAG_EXISTING_CONNECT | INTERNET_FLAG_NO_CACHE_WRITE,
			NULL);
		if (hOpenURL)
		{
			BOOL bSuccess = InternetReadFile(hOpenURL,
				buffer,
				sizeof(buffer) / sizeof(byte),
				&dwReadSize);
			HANDLE hFile = CreateFile(L"test.txt",
				GENERIC_READ | GENERIC_WRITE,
				FILE_SHARE_DELETE | FILE_SHARE_READ | FILE_SHARE_WRITE,
				NULL,
				CREATE_NEW,
				FILE_ATTRIBUTE_NORMAL,
				NULL);
			if (INVALID_HANDLE_VALUE != hFile)
			{
				while (bSuccess && dwReadSize)
				{
					if (!WriteFile(hFile, buffer, dwReadSize, &dwWriteSize, NULL))
					{
						printf_s("%s", "writeFile failed");
						break;
					}
					memset(&buffer, NULL, sizeof(buffer) / sizeof(byte));
					bSuccess = InternetReadFile(hOpenURL, buffer, sizeof(buffer) / sizeof(byte), &dwReadSize);
				}
			}
			CloseHandle(hFile);
			InternetCloseHandle(hInternet);
			printf_s("%s", "InternetOpenUrl success!");
		}
		else
		{
			InternetCloseHandle(hInternet);
			printf_s("%s", "InternetOpenUrl failed!");
		}
	}

	return 0;
}

